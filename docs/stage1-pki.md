```markdown
# Этап 1. Удостоверяющий центр (PKI / CA)

## 1. Цель и роль CA

На первом этапе развёрнут удостоверяющий центр (Certificate Authority, CA), который является корнем доверия для всей инфраструктуры.  
CA отвечает за:

- выпуск корневого сертификата (Root CA);
- выдачу и подписание серверных и клиентских сертификатов;
- отзыв сертификатов и ведение списка отозванных сертификатов (CRL).

CA‑сервер используется для обслуживания VPN‑сервера и других компонентов инфраструктуры, но сам не принимает пользовательский трафик.

---

## 2. Инфраструктура и изоляция CA‑сервера

- Облако: Yandex Cloud.  
- ОС: Ubuntu 24.04 LTS.  
- CA размещён на отдельной виртуальной машине в собственной сети (VPC/подсеть).  
- Доступ только по SSH по ключам, вход по паролю отключён.  
- Брандмауэр UFW настроен по принципу «минимально необходимого доступа»:
  - входящие соединения по умолчанию запрещены;
  - разрешён только порт 22/tcp (SSH);
  - исходящие соединения разрешены.

CA‑сервер не совмещает других ролей (нет OpenVPN, Prometheus, HTTP‑серверов и БД), что снижает поверхность атаки и соответствует принципу изоляции критичного компонента.

---

## 3. Структура PKI и корневой сертификат

PKI инициализирована с помощью Easy‑RSA 3.x в каталоге:

- базовый путь: `/etc/pki`;  
- каталог PKI: `/etc/pki/pki`.

Структура PKI включает:

- `ca.crt` – корневой самоподписанный сертификат CA (Root CA);  
- `private/ca.key` – приватный ключ CA (права доступа `600`, владелец `root:root`);  
- `issued/` – выданные сертификаты;  
- `reqs/` – запросы на сертификат (CSR);  
- `revoked/` – отозванные сертификаты;  
- `crl.pem` – список отозванных сертификатов (CRL);  
- `index.txt`, `serial`, `index.txt.attr` – служебные файлы Easy‑RSA. [file:43]

Файл политики PKI:

- `/etc/pki/vars` – настройки Distinguished Name и криптополитики, включая:
  - страну, регион, город, организацию, e‑mail, подразделение;
  - алгоритм ключей (EC), хэш‑функцию (SHA‑512);
  - срок действия корневого сертификата и выпускных сертификатов.

Корневой сертификат создаётся командой `build-ca`. Он самоподписанный (`subject` и `issuer` совпадают) и имеет заданный срок действия (порядка 10 лет). Скриншот вывода:

```bash
openssl x509 -in /etc/pki/pki/ca.crt -noout -subject -issuer -dates
```

используется как подтверждение успешного выпуска Root CA.

---

## 4. Скрипты автоматизации (scripts/)

Для автоматизации развёртывания и обслуживания CA подготовлен набор bash‑скриптов в каталоге `scripts/` репозитория, а также оркестратор `bootstrap.sh`, который отвечает за установку и вызов этих скриптов в правильном порядке.

### 4.1. bootstrap.sh (режим stage1)

Назначение: единая точка входа для развёртывания Этапа 1 на сервере `vm-ca`.

Использование на `vm-ca`:

```bash
cd ~/devops-final-pki-ca/scripts
chmod +x bootstrap.sh
sudo ./bootstrap.sh stage1
```

Основные действия режима `stage1`:

- копирует скрипты `install_ca.sh`, `init_ca.sh`, `sign_csr.sh`, `revoke_cert.sh` в `/usr/local/sbin` и делает их исполняемыми;
- вызывает `install_ca.sh` (подготовка сервера под CA);
- вызывает `init_ca.sh` с возможностью повторить ввод пароля при ошибке;
- выполняет автоматическую проверку `verify_stage1`:
    - наличие `/etc/pki/pki`, `ca.crt`, `private/ca.key`;
    - корректность прав на `ca.key` (600 или строже);
    - успешное чтение `ca.crt` через `openssl`;
    - активный UFW.


### 4.2. install_ca.sh

Назначение: подготовка сервера под роль CA.

Основные действия:

- обновляет список пакетов, устанавливает `easy-rsa`, `openssl`, `ufw`;
- создаёт каталог `/etc/pki` (если его ещё нет) с правами `700` и владельцем `root:root`;
- создаёт символьную ссылку `/usr/local/bin/easy-rsa` на `/usr/share/easy-rsa/easyrsa`, чтобы команда `easy-rsa` была доступна в PATH;
- настраивает UFW:
    - входящие — deny;
    - исходящие — allow;
    - разрешает только SSH (22/tcp);
    - включает UFW, если он был выключен.

Скрипт написан идемпотентно: повторный запуск не нарушает конфигурацию (существующие каталоги и symlink не перезаписываются, уже установленные пакеты не вызывают ошибки).

### 4.3. init_ca.sh

Назначение: инициализация PKI и создание корневого сертификата CA.

Основные действия:

- проверяет наличие каталога `/etc/pki/pki` и файла `ca.crt`:
    - если CA уже создан, выводит сообщение и завершается без изменений;
- выполняет `easy-rsa init-pki` в `/etc/pki`, создавая структуру PKI (если она ещё не инициализирована);
- создаёт файл `/etc/pki/vars` с политикой PKI (если он ещё не существует);
- запускает `easy-rsa build-ca`, в процессе чего:
    - администратор задаёт пароль для приватного ключа CA;
    - задаётся Common Name (CN) корневого сертификата.

После успешного выполнения в `/etc/pki/pki` появляются `ca.crt` и `private/ca.key`. Скрипт рассчитан на запуск от root/через sudo и не пересоздаёт уже имеющийся CA, что обеспечивает идемпотентность и защищает от случайной потери действующих сертификатов.

### 4.4. sign_csr.sh

Назначение: централизованный выпуск сертификатов по запросам (CSR).

Интерфейс:

- `sign_csr.sh server <путь_к_csr>` – выдать серверный сертификат;
- `sign_csr.sh client <путь_к_csr>` – выдать клиентский сертификат.

Основные действия:

- проверяет контекст: наличие PKI (`/etc/pki/pki`), `ca.crt`, `ca.key` и команды `easy-rsa`;
- проверяет существование CSR‑файла и определяет имя сертификата по имени файла;
- импортирует CSR в PKI (копирует в `pki/reqs/` и вызывает `easy-rsa import-req`);
- подписывает запрос командой `easy-rsa sign-req server|client <name>`;
- сохраняет выданный сертификат в `pki/issued/<name>.crt` и, при необходимости, копирует сертификат и `ca.crt` в отдельный каталог для удобной выдачи клиенту.

Скрипт не перезаписывает существующий сертификат с тем же именем без явного вмешательства, что предотвращает случайный повторный выпуск.

### 4.5. revoke_cert.sh

Назначение: отзыв ранее выданного сертификата и выпуск обновлённого CRL.

Интерфейс:

- `revoke_cert.sh <common-name>`

Основные действия:

- проверяет, что PKI и CA существуют, а сертификат с указанным Common Name присутствует в `pki/issued/`;
- вызывает `easy-rsa revoke <CN>` и затем `easy-rsa gen-crl`;
- обновляет файл `pki/crl.pem` и устанавливает корректные права на него.

Этот скрипт используется для управления доступом: при увольнении сотрудника или компрометации ключа соответствующий сертификат может быть отозван, а VPN‑сервер и другие сервисы смогут использовать CRL для проверки статуса сертификатов.

---

## 5. deb‑пакет devops-ca-tools (debian/ и artifacts/)

Для оформления конфигурации PKI и базового окружения в виде установимого артефакта подготовлен deb‑пакет `devops-ca-tools`.

### 5.1. Основные файлы сборки (папка debian/)

- `control` – задаёт метаданные пакета:
    - имя пакета (`devops-ca-tools`),
    - архитектура (`all`),
    - зависимости (`easy-rsa`, `openssl`, `ufw`, `bash`),
    - описание назначения пакета;
- `changelog` – история версий (минимум запись начального релиза);
- `compat` – уровень совместимости debhelper;
- `rules` – минимальный Makefile, делегирующий сборку утилите `dh`;
- `postinst` – скрипт, выполняющийся после установки пакета:
    - создаёт `/etc/pki` (если не существует),
    - настраивает права каталога,
    - создаёт симлинк `/usr/local/bin/easy-rsa`;
- `postrm` – поведение при удалении (по умолчанию не удаляет `/etc/pki`, чтобы не потерять ключи CA).

На основе этих файлов собран пакет `devops-ca-tools_1.0-1_all.deb`, который размещён в каталоге `artifacts/`.

### 5.2. Назначение пакета

deb‑пакет решает две задачи:

- формализует подготовку окружения CA (каталоги, права, зависимости, команду Easy‑RSA);
- позволяет быстро подготовить новую ВМ под роль CA, не выполняя вручную все шаги настройки.

Пакет устанавливается до запуска `bootstrap.sh stage1`: пакет готовит `/etc/pki` и `easy-rsa`, а `bootstrap.sh` разворачивает CA, устанавливает скрипты и проводит автоматические проверки.

---

## 6. Проверка воспроизводимости на новой ВМ

Для проверки автоматизации и воспроизводимости Этапа 1 используется отдельная тестовая виртуальная машина в Yandex Cloud.

Шаги:

1. Поднята новая ВМ с Ubuntu 24.04 LTS и SSH по ключу.
2. На ВМ склонированы из репозитория:
    - deb‑пакет `devops-ca-tools_1.0-1_all.deb`;
    - репозиторий с каталогами `scripts/` и `debian/`.
3. Установлены зависимости и deb‑пакет:
    - `apt install easy-rsa openssl ufw bash`;
    - `dpkg -i devops-ca-tools_1.0-1_all.deb`;
в результате созданы `/etc/pki` и симлинк `easy-rsa`.
4. Выполнен запуск оркестратора:

```bash
cd ~/devops-final-pki-ca/scripts
chmod +x bootstrap.sh
sudo ./bootstrap.sh stage1
```

5. Проверено:
    - наличие структуры `/etc/pki/pki` (включая `ca.crt` и `private/ca.key`);
    - корректность сертификата через `openssl x509 -in /etc/pki/pki/ca.crt -noout -subject -issuer -dates`;
    - успешное выполнение автоматической проверки `verify_stage1` (структура PKI, права на ключ, активный UFW).

Результат: CA успешно развернут на новой ВМ с использованием только deb‑пакета и скриптов из репозитория. Это демонстрирует, что Этап 1 реализован воспроизводимо и соответствует требованиям брифа: автоматизация, идемпотентность и возможность пересобрать инфраструктуру с нуля.