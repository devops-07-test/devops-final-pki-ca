```markdown
# Этап 2. VPN-сервер (OpenVPN)

## 1. Цель и роль VPN-сервера

На втором этапе развёрнут VPN-сервер на базе OpenVPN, который является единственной точкой входа сотрудников во внутреннюю сеть компании.  
Аутентификация выполняется по сертификатам, подписанным CA с Этапа 1.

VPN-сервер обеспечивает:

- защищённый туннель от пользовательских устройств до облачной сети (Yandex Cloud);
- контроль доступа за счёт выдачи/отзыва клиентских сертификатов;
- маршрутизацию трафика во внутренние подсети.

---

## 2. Инфраструктура и роли (vm-ca и vm-vpn)

В рамках брифа CA и VPN-сервер находятся на отдельных виртуальных машинах:

- `vm-ca` – удостоверяющий центр (Этап 1), выполняет только операции CA;
- `vm-vpn` – VPN-сервер (Этап 2), использует сертификат, подписанный CA.

На `vm-ca` развёрнут Root CA по инструкции из `docs/stage1-pki.md` через: `stage1`

```bash
cd ~/devops-final-pki-ca/scripts
sudo ./bootstrap.sh stage1
```

На `vm-vpn` разворачивается OpenVPN, все команды Этапа 2 выполняются только на этой машине.

Общие параметры:

- Облако: Yandex Cloud.
- ОС: Ubuntu 24.04 LTS.
- Отдельная ВМ `vm-vpn` в той же VPC, что и `vm-ca`.
- Публичный IP: включён (для клиентских подключений).
- Доступ по SSH по ключам, вход по паролю отключён.

Правила сетевой безопасности:

- Security Group Yandex Cloud:
    - входящие:
        - `22/tcp` – SSH (ограничен по IP администратора);
        - `1194/udp` – OpenVPN от клиентов (0.0.0.0/0 или ограниченный пул);
    - исходящие: разрешён доступ в интернет и во внутреннюю подсеть (для туннелирования трафика).
- Внутри ВМ дополнительно используется UFW/iptables для минимизации поверхности атаки.

---

## 3. Интеграция с CA (Этап 1 и bootstrap.sh)

CA (удостоверяющий центр) развёрнут на `vm-ca` командой:

```bash
cd ~/devops-final-pki-ca/scripts
sudo ./bootstrap.sh stage1
```

На `vm-vpn` используется тот же репозиторий, но запускается другой режим: `stage2`

```bash
cd ~/devops-final-pki-ca/scripts
sudo ./bootstrap.sh stage2
```

Связь между vm-ca и vm-vpn:

- На `vm-vpn` (после `bootstrap.sh stage2`) администратор вручную запускает:
    - `sudo stage2_request_server_csr.sh` — создаёт ключ и CSR для VPN-сервера.
- CSR копируется на `vm-ca` (scp/SSH).
- На `vm-ca` администратор подписывает его:

```bash
sudo sign_csr.sh server <путь_к_csr>
```

- Подписанный `server.crt` и `ca.crt` возвращаются на `vm-vpn` в каталог `/root/<name>-signed`.
- На `vm-vpn` сертификаты раскладываются по стандартным путям:

```bash
sudo stage2_fetch_signed_cert.sh <name>
```


Таким образом, приватный ключ CA никогда не покидает `vm-ca`, а VPN-сервер использует только подписанный сертификат и `ca.crt`.

---

## 4. Скрипты автоматизации (scripts/)

Все скрипты Stage2 лежат в `scripts/` репозитория и устанавливаются в `/usr/local/sbin` при запуске `bootstrap.sh`.
На `vm-vpn` предполагается, что репозиторий уже клонирован и запущен режим `stage2`.

### 4.1. stage2_install_openvpn.sh

Назначение: установка OpenVPN и базовая настройка сети на `vm-vpn`.

Этот скрипт вызывается автоматически из:

```bash
cd ~/devops-final-pki-ca/scripts
sudo ./bootstrap.sh stage2
```

Основные действия:

- устанавливает `openvpn`, `easy-rsa`, `iptables-persistent`;
- включает IP forwarding через файл `/etc/sysctl.d/99-openvpn-forward.conf`;
- при наличии UFW:
    - разрешает порт `1194/udp` для входящих соединений;
- работает идемпотентно: повторный запуск не ломает существующую конфигурацию.

---

### 4.2. stage2_request_server_csr.sh

Назначение: генерация приватного ключа и запроса на сертификат (CSR) для VPN-сервера.

Интерфейс (на `vm-vpn`):

- `sudo stage2_request_server_csr.sh` – интерактивно спрашивает CN (по умолчанию `vpn-server`).

Основные действия:

- создаёт каталог `/etc/openvpn/pki-requests`;
- генерирует:
    - приватный ключ `*.key`;
    - CSR `*.csr`;
- не перезаписывает существующие файлы без подтверждения;
- выводит пути к сгенерированным файлам и инструкцию по передаче CSR на `vm-ca`.

---

### 4.3. stage2_fetch_signed_cert.sh

Назначение: размещение подписанного серверного сертификата и `ca.crt` на `vm-vpn`.

Интерфейс:

- `sudo stage2_fetch_signed_cert.sh <basename>` – имя соответствует CSR/сертификату.

Основные действия:

- ожидает, что администратор скопировал с `vm-ca`:
    - `/root/<basename>-signed/<basename>.crt` – серверный сертификат;
    - `/root/<basename>-signed/ca.crt` – корневой сертификат CA;
- копирует файлы в `/etc/openvpn/pki/server.crt` и `/etc/openvpn/pki/ca.crt`;
- устанавливает корректные права на сертификаты.

---

### 4.4. stage2_configure_openvpn.sh

Назначение: создание конфигурации OpenVPN-сервера и запуск сервиса.

Основные действия:

- проверяет наличие:
    - `server.crt`, `ca.crt` и приватного ключа сервера;
- создаёт/обновляет `/etc/openvpn/server.conf` со следующими параметрами:
    - порт `1194/udp`;
    - режим `tun`;
    - шифр `AES-256-GCM`;
    - сеть клиентов `10.8.0.0/24`;
    - строгие опции TLS (минимальная версия 1.2, `remote-cert-tls server`);
- настраивает NAT (MASQUERADE) для сети `10.8.0.0/24` через внешний интерфейс;
- включает и перезапускает `openvpn@server` через systemd.

Скрипт вызывается вручную администратором на `vm-vpn` после того, как сертификаты сервера разложены в `/etc/openvpn/pki`:

```bash
sudo stage2_configure_openvpn.sh
```

Результат: после выполнения скрипта OpenVPN-сервер принимает подключения и маршрутизирует трафик клиентов.

---

### 4.5. stage2_create_client_ovpn.sh

Назначение: сборка клиентского профиля `.ovpn` на основе уже существующих сертификатов и ключей.

Интерфейс:

- `sudo stage2_create_client_ovpn.sh <client-name>`

Основные действия:

- предполагает, что на `vm-vpn` уже лежат:
    - `ca.crt`;
    - `client.crt`, `client.key` для указанного клиента (получены от CA через процесс CSR → `sign_csr.sh` → scp);
- собирает профиль `<client-name>.ovpn`, встраивая в него:
    - `ca`, `cert`, `key`;
    - адрес/порт VPN-сервера;
- устанавливает права `600` на созданный файл.

---

## 5. Проверка работоспособности Этапа 2

Минимальный набор проверок:

1. На `vm-vpn`:
    - `systemctl status openvpn@server` – сервис активен, без ошибок;
    - `ss -lun | grep 1194` – демон OpenVPN слушает `udp/1194`.
2. Клиентское подключение:
    - клиент с `.ovpn` подключается к VPN;
    - получает IP из сети `10.8.0.0/24` (например, `10.8.0.6`);
    - пингует внутренние ресурсы (ВМ в той же VPC).
3. Интеграция с CA:
    - при отзыве клиентского сертификата на `vm-ca` (`sudo revoke_cert.sh <CN>` и обновлённый CRL);
    - соответствующий клиент теряет доступ после обновления CRL на `vm-vpn`.

Дополнительно можно использовать упрощённую автоматическую проверку на `vm-vpn`:

```bash
cd ~/devops-final-pki-ca/scripts
sudo ./bootstrap.sh stage2-verify
```

`stage2-verify` проверяет:

- наличие `server.crt` и `ca.crt` в `/etc/openvpn/pki`;
- установленный OpenVPN;
- прослушивание порта `1194/udp`;
- включённый IP forwarding.

---

## 6. Связь с другими этапами

Результаты Этапа 2 используются:

- на Этапе 3 (мониторинг) – проверка доступности OpenVPN (порт/процесс/метрики);
- на Этапе 4 (резервное копирование) – резервное копирование конфигурации OpenVPN и его PKI;
- в документации (Этап 5) – руководство пользователя VPN и администратора;
- в плане развития (Этап 6) – возможный переход к HA, централизованному управлению клиентами, интеграции с LDAP/MFA и Secrets Management.

```

***